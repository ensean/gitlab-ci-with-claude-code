image: maven:3.8.6-openjdk-11

stages:
  - gendev
  - build
  - test

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"

cache:
  paths:
    - .m2/repository

gendev:
  stage: gendev
  image: node:24-alpine3.21
  tags:
    - java
  before_script:
    - apk update
    - apk add --no-cache git curl bash jq
    - npm install -g @anthropic-ai/claude-code
    - env

  script:
    - echo "Fetching merge request changes..."
    - git fetch origin $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
    - git diff origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME...HEAD > changes.diff
    - echo "Changed files:"
    - git diff --name-only origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME...HEAD
    - echo "Sending changes to Claude Code for review..."
    - |
      REVIEW_RESULT=$(claude \
        -p "Review the code changes in the changes.diff file and provide feedback on code quality, potential issues, and suggestions for improvement." \
        --permission-mode acceptEdits \
        --allowedTools "Bash(*) Read(*)" \
        --debug 2>&1 || echo "Review completed")
    - echo "Review result:"
    - echo "$REVIEW_RESULT"
    - echo "Posting review result as comment to MR..."
    - |
      jq -n \
        --arg title "ðŸ¤– Claude Code Review" \
        --arg review "$REVIEW_RESULT" \
        '{body: ($title + "\n\n" + $review)}' > comment.json
      cat comment.json
      curl --request POST \
        --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
        --header "Content-Type: application/json" \
        --data @comment.json \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID/notes"
  
  artifacts:
    paths:
      - changes.diff
      - comment.json
    expire_in: 7 days
    when: always
  
  variables:
    AWS_REGION: "ap-northeast-1"
    CLAUDE_CODE_USE_BEDROCK: "1"
    ANTHROPIC_MODEL: "global.anthropic.claude-sonnet-4-5-20250929-v1:0"

  only:
    - merge_requests
  allow_failure: true

build:
  stage: build
  tags:
    - java
  script:
    - mvn clean package -DskipTests=true
  artifacts:
    paths:
      - target/
    expire_in: 1 hour

test:
  stage: test
  tags:
    - java
  script:
    - mvn test
  dependencies:
    - build
